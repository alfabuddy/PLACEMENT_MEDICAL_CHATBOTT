<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Assistant Chatbot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header class="chat-header">
            <div class="header-content">
                <div class="logo">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                    </svg>
                </div>
                <div class="header-text">
                    <h1>Medical Assistant</h1>
                    <p class="status">
                        <span class="status-dot"></span>
                        Online
                    </p>
                </div>
            </div>
        </header>

        <div class="chat-container" id="chatContainer">
            <div class="welcome-message">
                <div class="welcome-icon">
                    <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </div>
                <h2>Welcome to Medical Assistant</h2>
                <p>
                    I'm here to help answer your medical questions.
                    Please note that I provide general information and
                    should not replace professional medical advice.
                </p>
            </div>
        </div>

        <div class="input-container">
            <div class="input-wrapper">
                <button class="attach-btn" aria-label="Attach file">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                    </svg>
                </button>

                <input
                    type="text"
                    id="userInput"
                    placeholder="Type your medical question here..."
                    aria-label="Message input"
                >

                <button class="send-btn" id="sendBtn" aria-label="Send message">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>

            <p class="disclaimer">
                ⚠️ Chat history is stored locally on your device
            </p>

            <button onclick="clearChat()" style="margin-top:6px;">Clear Chat</button>
        </div>
    </div>

    <script>
        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');

        /* ============================
           LOAD CHAT HISTORY
        ============================ */
        let chatHistory = JSON.parse(localStorage.getItem("chatHistory")) || [];

        /* ============================
           RESTORE HISTORY ON RELOAD
        ============================ */
        window.onload = () => {
            if (chatHistory.length > 0) {
                const welcomeMsg = document.querySelector('.welcome-message');
                if (welcomeMsg) welcomeMsg.remove();

                chatHistory.forEach((msg, index) => {
                    addMessage(msg, index % 2 === 0 ? "user" : "bot");
                });
            }
        };

        /* ============================
           EVENTS
        ============================ */
        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        function sendMessage() {
            const message = userInput.value.trim();
            if (message === '') return;

            const welcomeMsg = document.querySelector('.welcome-message');
            if (welcomeMsg) welcomeMsg.remove();

            // USER MESSAGE
            addMessage(message, 'user');
            chatHistory.push(message);
            localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
            userInput.value = '';

            // THINKING
            addMessage('Thinking...', 'bot');

            const formData = new FormData();
            formData.append('msg', message);
            chatHistory.forEach((entry) => {
                formData.append('history[]', entry);
            });

            fetch('/get', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(data => {
                const thinkingMessage = chatContainer.lastChild;
                if (thinkingMessage) thinkingMessage.remove();

                addMessage(data, 'bot');
                chatHistory.push(data);
                localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
            })
            .catch(() => {
                const thinkingMessage = chatContainer.lastChild;
                if (thinkingMessage) thinkingMessage.remove();
                addMessage('Sorry, something went wrong.', 'bot');
            });
        }

        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;

            const avatar = document.createElement('div');
            avatar.className = 'avatar';

            avatar.innerHTML = sender === 'bot'
                ? `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                   </svg>`
                : `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                   </svg>`;

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.innerText = text;

            const time = document.createElement('span');
            time.className = 'message-time';
            time.textContent = new Date().toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit'
            });

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(bubble);
            bubble.appendChild(time);

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function clearChat() {
            localStorage.removeItem("chatHistory");
            chatContainer.innerHTML = "";
        }
    </script>
</body>
</html>
